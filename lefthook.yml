# Configuration Lefthook optimis√©e pour GymArt
# Automatise la qualit√© de code et les v√©rifications avant commit/push

pre-commit:
  parallel: true  # Ex√©cute les commandes en parall√®le pour plus de rapidit√©
  commands:
    # Formatage automatique avec Prettier
    prettier:
      glob: "**/*.{js,jsx,ts,tsx,css,md,json,yml,yaml}"
      run: npx prettier --write {staged_files}
      stage_fixed: true  # Re-ajoute automatiquement les fichiers corrig√©s
      fail_text: "‚ùå Prettier formatting failed. Please check the output above."
      
    # Linting ESLint avec auto-fix pour le client
    eslint-client:
      glob: "client/**/*.{js,jsx,ts,tsx}"
      run: cd client && npx eslint --fix {staged_files} --no-error-on-unmatched-pattern
      stage_fixed: true
      fail_text: "‚ùå ESLint client failed. Please fix the linting errors above."
      
    # V√©rification TypeScript pour le client
    typecheck-client:
      glob: "client/**/*.{ts,tsx}"
      run: cd client && npx tsc --noEmit
      fail_text: "‚ùå TypeScript check failed. Please fix the type errors above."
      
    # V√©rification de la structure du projet
    check-structure:
      glob: "*"
      run: |
        if [ ! -d "api" ] || [ ! -d "client" ]; then
          echo "‚ùå Structure monorepo manquante (api/ et client/ requis)"
          exit 1
        fi
        echo "‚úÖ Structure monorepo valid√©e"

# V√©rification des messages de commit
commit-msg:
  commands:
    commitlint:
      run: npx commitlint --edit {1}
      fail_text: |
        ‚ùå Message de commit invalide!
        
        Format requis: <type>: <description>
        
        Types autoris√©s:
        - feat: nouvelle fonctionnalit√©
        - fix: correction de bug
        - docs: documentation
        - style: formatage
        - refactor: refactoring
        - test: ajout de tests
        - chore: maintenance
        - ci: int√©gration continue
        
        Exemple: feat: add user authentication

# V√©rifications avant push
pre-push:
  commands:
    # Tests backend (si disponibles)
    test-api:
      run: |
        if [ -f "api/package.json" ] && grep -q '"test"' api/package.json; then
          echo "üß™ Ex√©cution des tests backend..."
          cd api && npm test
        else
          echo "‚ÑπÔ∏è Pas de tests backend configur√©s, skip"
        fi
      fail_text: "‚ùå Tests backend √©chou√©s. Corrigez avant de push!"
      
    # Build du frontend pour v√©rifier les erreurs
    build-client:
      run: |
        echo "üèóÔ∏è V√©rification du build frontend..."
        cd client && npm run build
      fail_text: "‚ùå Build client √©chou√©. Corrigez les erreurs avant de push!"
      
    # V√©rification de la sant√© de l'API (si elle tourne)
    api-health:
      run: |
        if curl -f -s http://localhost:3001/api/health >/dev/null 2>&1; then
          echo "‚úÖ API health check: OK"
        else
          echo "‚ÑπÔ∏è API non accessible (normal si pas d√©marr√©e)"
        fi
      
    # V√©rification de la base de donn√©es (si Docker tourne)
    db-health:
      run: |
        if docker ps | grep -q postgres; then
          echo "üîç V√©rification PostgreSQL..."
          if docker-compose exec -T postgres pg_isready -U postgres -d gymart >/dev/null 2>&1; then
            echo "‚úÖ PostgreSQL: OK"
          else
            echo "‚ö†Ô∏è PostgreSQL non accessible"
          fi
        else
          echo "‚ÑπÔ∏è PostgreSQL non d√©marr√© (normal en d√©veloppement)"
        fi

# C√©l√©bration apr√®s commit r√©ussi
post-commit:
  commands:
    celebrate:
      run: echo "‚úÖ Commit GymArt valid√©! üèãÔ∏è Code format√© et v√©rifi√© automatiquement."
